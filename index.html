<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Camera Preview</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; }
  #adminDashboard {
    display: none;
  }
  #cameraPreview {
    display: block;
    width: 100%;
    max-width: 560px;
    margin: 20px auto;
    background: black;
  }
  #captureButton {
    padding: 10px 18px;
    font-size: 16px;
    border: none;
    border-radius: 6px;
    background-color: #007bff;
    color: white;
    cursor: pointer;
  }
  #captureButton:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  #adminPanel {
    max-width: 900px;
    margin: 0 auto 40px;
    padding: 0 20px 40px;
  }
  #adminPanel h2,
  #adminPanel p {
    margin-bottom: 12px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  th, td {
    padding: 12px;
    border-bottom: 1px solid #eee;
    text-align: left;
    font-size: 14px;
  }
  th {
    background: #f5f5f5;
  }
  tbody tr:nth-child(even) {
    background: #fafafa;
  }
  td img {
    max-width: 120px;
    border-radius: 4px;
  }
  #streamControls {
    margin: 20px 0 30px;
    padding: 16px;
    border: 1px solid #e2e2e2;
    border-radius: 8px;
    background: #fafafa;
  }
  #streamControls h3 {
    margin-top: 0;
    margin-bottom: 12px;
  }
  #streamControls label {
    display: block;
    font-weight: 600;
    margin-bottom: 12px;
  }
  #streamControls input {
    width: 100%;
    margin-top: 6px;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
  }
  #streamControls .buttonRow {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 12px;
  }
  #streamControls .secondary {
    background-color: #6c757d;
  }
  #streamControls .hint {
    font-size: 12px;
    color: #666;
    margin-top: 10px;
  }
  #articleView {
    max-width: 720px;
    margin: 60px auto;
    padding: 0 20px 80px;
    line-height: 1.7;
    color: #333;
  }
  #articleView h1 {
    font-size: 32px;
    margin-bottom: 16px;
  }
  #articleView p {
    margin-bottom: 16px;
  }
  #articleView .author {
    font-size: 14px;
    color: #777;
    margin-bottom: 30px;
  }
  #openAdminHint {
    font-size: 12px;
    color: #bbb;
    text-align: center;
    margin-top: 40px;
    user-select: none;
  }
</style>
</head>
<body>

<main id="articleView">
  <h1>The Quiet Charm of Waiting Rooms</h1>
  <p class="author">By A. Nonymous â€¢ Updated regularly</p>
  <p>Waiting rooms might just be the most underrated spaces in modern life. They exist in the margins between intention and action, quietly holding our plans together. The chairs are always slightly too firm, the artwork always just abstract enough to feel expensive but never memorable, and the stack of magazines inevitably outdated yet oddly comforting.</p>
  <p>There is a certain poetry in their predictability. The soft rustle of pages turning, the muted announcements over distant speakers, the scent of hand sanitizer and recycled air. Here, time slows to a bureaucratic crawl. You are no longer defined by what you do, but by what you are waiting for.</p>
  <p>In an age obsessed with efficiency, waiting rooms remind us that not everything can be rushed. Sometimes, the most productive thing you can do is sit quietly, take a breath, and let the moment exist without demanding anything of it.</p>
  <p>So the next time you find yourself in one, look up from your phone. Notice the light filtering through the blinds, the soft hum of the ventilation, the shared, unspoken patience of everyone around you. Waiting rooms are liminal, yes, but perhaps in that gentle pause lies a kind of beauty.</p>
  <p id="openAdminHint">Press Ctrl + Shift + A to open an additional tab.</p>
</main>

<section id="adminDashboard">
  <video id="cameraPreview" autoplay playsinline></video>
  <h2>Admin Panel</h2>
  <p>Capture snapshots to log date, time, device type, IP address, and the captured image.</p>
  <div id="streamControls">
    <h3>Remote Stream Setup</h3>
    <label>
      Remote video stream URL
      <input id="streamUrlInput" type="url" placeholder="e.g. http://192.168.1.20:8080/video" autocomplete="off">
    </label>
    <label>
      Snapshot endpoint (optional)
      <input id="snapshotUrlInput" type="url" placeholder="e.g. http://192.168.1.20:8080/shot.jpg" autocomplete="off">
    </label>
    <div class="buttonRow">
      <button id="applyStreamButton" class="secondary" type="button">Use Remote Stream</button>
      <button id="useLocalButton" class="secondary" type="button">Use Local Camera</button>
    </div>
    <p class="hint">Ensure your phone and laptop share the same network. Start a streaming app on the phone (IP Webcam, EpocCam, DroidCam, Iriun), copy the URL it shows, and paste it here. Use the snapshot endpoint if the app provides one for still images.</p>
  </div>
  <button id="captureButton" disabled>Loading camera...</button>
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Capture Date</th>
        <th>Capture Time</th>
        <th>Device Type</th>
        <th>IP Address</th>
        <th>Captured Image</th>
      </tr>
    </thead>
    <tbody id="captureTableBody">
      <tr><td colspan="6">No captures yet.</td></tr>
    </tbody>
  </table>
</section>

<script>
const cameraPreview = document.getElementById('cameraPreview');
const captureButton = document.getElementById('captureButton');
const captureTableBody = document.getElementById('captureTableBody');
const articleView = document.getElementById('articleView');
const adminDashboard = document.getElementById('adminDashboard');
const streamUrlInput = document.getElementById('streamUrlInput');
const snapshotUrlInput = document.getElementById('snapshotUrlInput');
const applyStreamButton = document.getElementById('applyStreamButton');
const useLocalButton = document.getElementById('useLocalButton');

let activeStream = null;
let userIpAddress = 'Loading...';
let captureCount = 0;
const captureCanvas = document.createElement('canvas');
const captureContext = captureCanvas.getContext('2d');
let remoteSnapshotUrl = '';
let currentMode = 'local';

async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    cameraPreview.srcObject = stream;
    activeStream = stream;
    cameraPreview.removeAttribute('src');
    captureButton.textContent = 'Capture Snapshot';
    captureButton.disabled = false;
    cameraPreview.addEventListener('loadedmetadata', () => {
      captureCanvas.width = cameraPreview.videoWidth;
      captureCanvas.height = cameraPreview.videoHeight;
    }, { once: true });
  } catch (err) {
    alert('Camera access denied or unavailable.');
    console.error(err);
    captureButton.textContent = 'Camera not available';
  }
}

async function getUserIp() {
  try {
    const response = await fetch('https://api.ipify.org?format=json');
    if (!response.ok) throw new Error('Failed to fetch IP');
    const { ip } = await response.json();
    userIpAddress = ip;
  } catch (error) {
    console.error('Unable to get IP address.', error);
    userIpAddress = 'Unavailable';
  }
}

function detectDeviceType() {
  const ua = navigator.userAgent || navigator.vendor || window.opera;
  if (/android/i.test(ua)) return 'Android';
  if (/iPad|iPhone|iPod/.test(ua) && !window.MSStream) return 'iOS';
  if (/Windows/i.test(ua)) return 'Windows';
  if (/Macintosh/i.test(ua)) return 'macOS';
  if (/Linux/i.test(ua)) return 'Linux';
  return 'Unknown';
}

async function recordCapture() {
  if (!activeStream) {
    alert('Camera stream not ready.');
    return;
  }

  if (!captureCanvas.width || !captureCanvas.height) {
    captureCanvas.width = cameraPreview.videoWidth || 640;
    captureCanvas.height = cameraPreview.videoHeight || 480;
  }

  let snapshotDataUrl = null;

  if (currentMode === 'local') {
    captureContext.drawImage(cameraPreview, 0, 0, captureCanvas.width, captureCanvas.height);
    snapshotDataUrl = captureCanvas.toDataURL('image/png');
  } else {
    snapshotDataUrl = null;
    try {
      captureContext.drawImage(cameraPreview, 0, 0, captureCanvas.width, captureCanvas.height);
      snapshotDataUrl = captureCanvas.toDataURL('image/png');
    } catch (drawErr) {
      if (remoteSnapshotUrl) {
        captureButton.disabled = true;
        captureButton.textContent = 'Fetching snapshot...';
        snapshotDataUrl = null;
        try {
          const response = await fetch(`${remoteSnapshotUrl}?ts=${Date.now()}`, { mode: 'cors' });
          if (!response.ok) throw new Error('Snapshot fetch failed');
          const blob = await response.blob();
          const imageBitmap = await createImageBitmap(blob);
          captureCanvas.width = imageBitmap.width;
          captureCanvas.height = imageBitmap.height;
          captureContext.drawImage(imageBitmap, 0, 0);
          snapshotDataUrl = captureCanvas.toDataURL('image/png');
        } catch (fetchErr) {
          alert('Unable to capture snapshot from remote stream. Check CORS settings or provide a snapshot endpoint that allows cross-origin access.');
          console.error(fetchErr);
          captureButton.disabled = false;
          captureButton.textContent = 'Capture Snapshot';
          return;
        } finally {
          captureButton.disabled = false;
          captureButton.textContent = 'Capture Snapshot';
        }
      } else {
        alert('Remote stream does not allow direct capture. Provide a snapshot endpoint.');
        console.error(drawErr);
        return;
      }
    }
  }

  if (!snapshotDataUrl) {
    alert('Failed to capture snapshot.');
    return;
  }

  const now = new Date();
  const dateString = now.toLocaleDateString();
  const timeString = now.toLocaleTimeString();
  const deviceType = detectDeviceType();

  captureCount += 1;

  const row = document.createElement('tr');
  row.innerHTML = `
    <td>${captureCount}</td>
    <td>${dateString}</td>
    <td>${timeString}</td>
    <td>${deviceType}</td>
    <td>${userIpAddress}</td>
  `;

  // Remove placeholder row if present
  if (captureTableBody.children.length === 1 && captureTableBody.children[0].children.length === 1) {
    captureTableBody.innerHTML = '';
  }

  const imageCell = document.createElement('td');
  const imageElement = document.createElement('img');
  imageElement.src = snapshotDataUrl;
  imageElement.alt = `Capture ${captureCount}`;
  imageCell.appendChild(imageElement);
  row.appendChild(imageCell);

  captureTableBody.appendChild(row);
}

captureButton.addEventListener('click', recordCapture);

function initializeView() {
  const params = new URLSearchParams(window.location.search);
  const isAdmin = params.get('admin') === '1';

  if (isAdmin) {
    articleView.style.display = 'none';
    adminDashboard.style.display = 'block';
    startCamera();
    getUserIp();
  } else {
    adminDashboard.style.display = 'none';
    articleView.style.display = 'block';
    captureButton.textContent = 'Admin access required';
  }
}

window.addEventListener('DOMContentLoaded', initializeView);

document.addEventListener('keydown', (event) => {
  if (event.ctrlKey && event.shiftKey && event.code === 'KeyA') {
    event.preventDefault();
    const adminUrl = new URL(window.location.href);
    adminUrl.searchParams.set('admin', '1');
    window.open(adminUrl.toString(), '_blank', 'noopener');
  }
});

function stopLocalStream() {
  if (activeStream) {
    activeStream.getTracks().forEach(track => track.stop());
  }
  activeStream = null;
}

async function switchToLocalCamera() {
  currentMode = 'local';
  remoteSnapshotUrl = '';
  captureButton.textContent = 'Loading camera...';
  captureButton.disabled = true;
  cameraPreview.src = '';
  stopLocalStream();
  await startCamera();
}

function switchToRemoteStream() {
  const streamUrl = streamUrlInput.value.trim();
  remoteSnapshotUrl = snapshotUrlInput.value.trim();

  if (!streamUrl) {
    alert('Enter a remote video stream URL first.');
    return;
  }

  stopLocalStream();
  currentMode = 'remote';
  captureButton.disabled = true;
  captureButton.textContent = 'Connecting to stream...';
  cameraPreview.srcObject = null;
  cameraPreview.src = streamUrl;
  cameraPreview.load();
  cameraPreview.play().then(() => {
    captureButton.disabled = false;
    captureButton.textContent = 'Capture Snapshot';
  }).catch(err => {
    alert('Unable to play remote stream. Check the URL and ensure the stream is reachable.');
    console.error(err);
    captureButton.textContent = 'Stream unavailable';
  });
}

applyStreamButton.addEventListener('click', switchToRemoteStream);
useLocalButton.addEventListener('click', switchToLocalCamera);
</script>

</body>
</html>

